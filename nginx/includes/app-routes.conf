# =============================================================================
# Shared application routes (auth, API, health, WebSocket, Chat UI)
# Include from nginx.conf and nginx-ssl.conf
# =============================================================================

# Backend auth endpoints (specific FastAPI routes)
# These are the backend-only auth routes that should NOT go to chat-ui
location ~ ^/api/auth/(login|forgot-password|reset-password|validate-token|refresh-token|current-user|verify)$ {
    proxy_pass http://api_backend/api/auth/$1$is_args$args;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# All other /api/auth/* routes go to chat-ui (NextAuth + custom routes)
# This includes: callback, signin, signout, session, csrf, providers, rate-limit, ws-token
# New chat-ui auth routes will automatically work without nginx config changes
location /api/auth/ {
    proxy_pass http://chat_ui/api/auth/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Chat-UI OAuth routes (exchange-token, disconnect)
location /api/oauth/ {
    proxy_pass http://chat_ui/api/oauth/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Backend API endpoints (all routes under /api/)
location /api/ {
    limit_req zone=api_limit burst=50 nodelay;
    limit_conn conn_limit 20;

    proxy_pass http://api_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# Health check
location /health {
    proxy_pass http://api_backend/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Metrics endpoint (for Prometheus - internal only)
location /metrics {
    # Restrict to internal Docker networks and localhost
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;

    proxy_pass http://api_backend/metrics;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}

# WebSocket endpoint
location /ws {
    proxy_pass http://api_backend/ws;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket specific timeouts
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;
}

# Root: backend checks tenant count, redirects to /register if none, else proxies to Chat UI
location = / {
    proxy_pass http://api_backend/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Chat UI (frontend) - all other paths
location / {
    proxy_pass http://chat_ui;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
