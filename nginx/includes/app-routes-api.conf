# =============================================================================
# API/health/ws routes only (no location / or location = /)
# Used by HTTP server when behind SSL-terminating proxy (X-Forwarded-Proto: https)
# =============================================================================

# JSON error responses for API clients (413 from nginx itself, not upstream)
error_page 413 = @error_413_json;
location @error_413_json {
    default_type application/json;
    return 413 '{"detail":"File too large. Maximum upload size is 50 MB. If you are behind a reverse proxy, ensure its client_max_body_size is at least 50M.","type":"upload_error","code":413}';
}

# Backend auth endpoints (specific FastAPI routes)
location ~ ^/api/auth/(login|forgot-password|reset-password|validate-token|refresh-token|current-user|verify)$ {
    proxy_pass http://api_backend/api/auth/$1$is_args$args;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# All other /api/auth/* routes go to chat-ui (NextAuth + custom routes)
location /api/auth/ {
    proxy_pass http://chat_ui/api/auth/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Chat-UI OAuth routes (exchange-token, disconnect)
location /api/oauth/ {
    proxy_pass http://chat_ui/api/oauth/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Backend API endpoints (all routes under /api/)
location /api/ {
    client_max_body_size 50M;
    limit_req zone=api_limit burst=50 nodelay;
    limit_conn conn_limit 20;

    proxy_pass http://api_backend;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 60s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
}

# Health check
location /health {
    proxy_pass http://api_backend/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Metrics endpoint (for Prometheus - internal only)
location /metrics {
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;

    proxy_pass http://api_backend/metrics;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}

# WebSocket endpoint
location /ws {
    proxy_pass http://api_backend/ws;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;
}
