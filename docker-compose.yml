# =============================================================================
# Worqlo Self-Hosted - Docker Compose
# =============================================================================
# Usage:
#   docker compose up -d                    # Start all services
#   docker compose --profile ollama up -d   # Start with local Ollama LLM
#   docker compose logs -f api              # View API logs
#   docker compose down                     # Stop all services
# =============================================================================
# Note: api and celery-worker share many env vars by design (both run app code
# that reads settings). TIKTOKEN_RS_CACHE_DIR uses a default so it can be set
# once in .env if you need a different path.
# =============================================================================

name: worqlo

services:
  # ===========================================================================
  # Reverse Proxy
  # ===========================================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: worqlo-nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
      - "${MINIO_PORT:-9000}:9000"   # MinIO S3 API - browser file access
    volumes:
      - ${NGINX_CONF:-./nginx/nginx.conf}:/etc/nginx/nginx.conf:ro
      - ./nginx/includes:/etc/nginx/includes:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      api:
        condition: service_healthy
      chat-ui:
        condition: service_healthy
    networks:
      - frontend-network
      - backend-network
      - minio-network   # For MinIO proxy on port 9000
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    # Security hardening
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID

  # ===========================================================================
  # Frontend - Next.js Chat UI
  # ===========================================================================
  chat-ui:
    build:
      # When deploy is submodule at backend/deploy: ../chat-ui = backend/chat-ui
      # Standalone (install.sh): GHCR override skips build
      context: ../chat-ui
      dockerfile: Dockerfile
      args:
        # Build-time env for client-side (browser) API calls via nginx
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost/api}
        - NEXT_PUBLIC_WEBSOCKET_URL=${NEXT_PUBLIC_WEBSOCKET_URL:-ws://localhost/ws}
    container_name: worqlo-chat-ui
    restart: unless-stopped
    # Remove external port - only accessible via nginx
    # ports:
    #   - "${UI_PORT:-3000}:3000"
    environment:
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost}
      - NEXTAUTH_URL_INTERNAL=http://chat-ui:3000
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:?NEXTAUTH_SECRET is required}
      # JWT Configuration (must match backend)
      - JWT_WS_SECRET=${JWT_WS_SECRET:?JWT_WS_SECRET is required}
      - JWT_ISSUER=${JWT_ISSUER:-worqlo-self-hosted}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-worqlo-backend-api}
      # Client-side URLs (also in build.args for bundle; here for runtime if app reads them)
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost/api}
      - NEXT_PUBLIC_WEBSOCKET_URL=${NEXT_PUBLIC_WEBSOCKET_URL:-ws://localhost/ws}
      # Server-side API URL - for Docker internal networking (Next.js API routes â†’ FastAPI)
      - BACKEND_API_URL=${BACKEND_API_URL:-http://api:8000/api}
    networks:
      - frontend-network
      - backend-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    depends_on:
      api:
        condition: service_healthy
    # Security hardening
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # ===========================================================================
  # Backend - FastAPI
  # ===========================================================================
  api:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    env_file:
      - .env
    container_name: worqlo-api
    restart: unless-stopped
    # Remove external port - only accessible via nginx
    # ports:
    #   - "${API_PORT:-8000}:8000"
    environment:
      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-worqlo}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@postgres:5432/${POSTGRES_DB:-worqlo}
      # Redis
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      # JWT Authentication
      - JWT_WS_SECRET=${JWT_WS_SECRET:?JWT_WS_SECRET is required}
      - JWT_ISSUER=${JWT_ISSUER:-worqlo-self-hosted}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-worqlo-backend-api}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_ACCESS_TOKEN_EXPIRE_HOURS=${JWT_ACCESS_TOKEN_EXPIRE_HOURS:-24}
      # LLM Configuration
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - GROK_API_KEY=${GROK_API_KEY:-}
      - GROK_MODEL=${GROK_MODEL:-grok-3-mini}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.1:8b}
      - SGLANG_BASE_URL=${SGLANG_BASE_URL:-}
      - SGLANG_MODEL=${SGLANG_MODEL:-}
      - SGLANG_REASONING_EFFORT=${SGLANG_REASONING_EFFORT:-medium}
      - SGLANG_ENABLE_CODE_INTERPRETER=${SGLANG_ENABLE_CODE_INTERPRETER:-false}
      - SGLANG_ENABLE_WEB_SEARCH=${SGLANG_ENABLE_WEB_SEARCH:-false}
      - SGLANG_TEMPERATURE=${SGLANG_TEMPERATURE:-}
      - SGLANG_TOP_P=${SGLANG_TOP_P:-}
      - SGLANG_MAX_OUTPUT_TOKENS=${SGLANG_MAX_OUTPUT_TOKENS:-}
      # Harmony/tiktoken vocab cache (SGLang provider; writable in image)
      - TIKTOKEN_RS_CACHE_DIR=${TIKTOKEN_RS_CACHE_DIR:-/app/.cache/tiktoken_rs}
      # Embedding (Knowledge Base)
      - KB_EMBEDDING_PROVIDER=${KB_EMBEDDING_PROVIDER:-openai}
      - KB_EMBEDDING_BASE_URL=${KB_EMBEDDING_BASE_URL:-}
      - KB_EMBEDDING_MODEL=${KB_EMBEDDING_MODEL:-text-embedding-3-small}
      - KB_EMBEDDING_DIMENSIONS=${KB_EMBEDDING_DIMENSIONS:-1536}
      # Storage (MinIO/S3)
      - STORAGE_BACKEND=${STORAGE_BACKEND:-s3}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-worqlo}
      - S3_REGION=${S3_REGION:-us-east-1}
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-worqlo}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:?MINIO_ROOT_PASSWORD is required}
      - S3_ENDPOINT_URL=http://minio:9000
      - S3_PUBLIC_ENDPOINT_URL=${S3_PUBLIC_ENDPOINT_URL:-http://localhost:9000}
      - S3_PRESIGNED_URL_EXPIRY=${S3_PRESIGNED_URL_EXPIRY:-3600}
      # Public API URL (for generating absolute file view links)
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost/api}
      # CORS - CHANGED: No wildcard by default
      - CORS_ALLOW_ORIGINS=${CORS_ALLOW_ORIGINS:-http://localhost,http://localhost:80,http://localhost:3000}
      # Logging & debug (match deploy/.env)
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG_CONNECTOR_HTTP=${DEBUG_CONNECTOR_HTTP:-false}
      - DEBUG_CONNECTORS_VERBOSE=${DEBUG_CONNECTORS_VERBOSE:-false}
      - DEBUG_WORKFLOWS=${DEBUG_WORKFLOWS:-false}
      - ENABLE_FABRICATION_GUARD=${ENABLE_FABRICATION_GUARD:-false}
      - LOG_TOOL_RESPONSE=${LOG_TOOL_RESPONSE:-false}
      # Email (optional)
      - EMAIL_SMTP_HOST=${EMAIL_SMTP_HOST:-}
      - EMAIL_SMTP_PORT=${EMAIL_SMTP_PORT:-587}
      - EMAIL_SMTP_USER=${EMAIL_SMTP_USER:-}
      - EMAIL_SMTP_PASSWORD=${EMAIL_SMTP_PASSWORD:-}
      - EMAIL_FROM_ADDRESS=${EMAIL_FROM_ADDRESS:-}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-}
      - EMAIL_USE_TLS=${EMAIL_USE_TLS:-true}
      - EMAIL_ATTACHMENT_MAX_SIZE_MB=${EMAIL_ATTACHMENT_MAX_SIZE_MB:-10}
      # Frontend URLs for email links (activation, password reset)
      - FRONTEND_RESET_PASSWORD_URL=${FRONTEND_RESET_PASSWORD_URL:-http://localhost/reset-password}
      - FRONTEND_LOGIN_URL=${FRONTEND_LOGIN_URL:-http://localhost}
      # Internal Chat UI URL (for root proxy when tenants exist)
      - CHAT_UI_INTERNAL_URL=${CHAT_UI_INTERNAL_URL:-http://chat-ui:3000}
      # LangSmith (optional)
      - LANGSMITH_TRACING=${LANGSMITH_TRACING:-false}
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY:-}
      - LANGSMITH_PROJECT=${LANGSMITH_PROJECT:-worqlo-self-hosted}
    volumes:
      - uploads-data:/app/uploads
    networks:
      - backend-network
      - db-network
      - external-network  # Required for OpenAI, SMTP, LangSmith, webhooks
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    # Security hardening
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # ===========================================================================
  # Celery Worker - Background Tasks
  # ===========================================================================
  celery-worker:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    env_file:
      - .env
    container_name: worqlo-celery-worker
    restart: unless-stopped
    # Pool is auto-detected in celery_app.py: prefork on Linux (Docker)
    # Adjust --concurrency based on container CPU limits (default: 4)
    command: >
      celery -A app.workflows.celery_app worker
      --loglevel=info
      --concurrency=4
      -E
      --without-gossip
      --without-mingle
      --without-heartbeat
      -Q default
    environment:
      # Skip migrations/seeds (handled by API container)
      - SKIP_STARTUP_TASKS=true
      # Database & Redis
      - DATABASE_URL=postgresql://${POSTGRES_USER:-worqlo}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@postgres:5432/${POSTGRES_DB:-worqlo}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      # JWT
      - JWT_WS_SECRET=${JWT_WS_SECRET}
      # LLM
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GROK_API_KEY=${GROK_API_KEY:-}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - SGLANG_BASE_URL=${SGLANG_BASE_URL:-}
      - SGLANG_MODEL=${SGLANG_MODEL:-}
      - SGLANG_REASONING_EFFORT=${SGLANG_REASONING_EFFORT:-medium}
      - SGLANG_ENABLE_CODE_INTERPRETER=${SGLANG_ENABLE_CODE_INTERPRETER:-false}
      - SGLANG_ENABLE_WEB_SEARCH=${SGLANG_ENABLE_WEB_SEARCH:-false}
      - SGLANG_TEMPERATURE=${SGLANG_TEMPERATURE:-}
      - SGLANG_TOP_P=${SGLANG_TOP_P:-}
      - SGLANG_MAX_OUTPUT_TOKENS=${SGLANG_MAX_OUTPUT_TOKENS:-}
      - TIKTOKEN_RS_CACHE_DIR=${TIKTOKEN_RS_CACHE_DIR:-/app/.cache/tiktoken_rs}
      # Embedding (Knowledge Base)
      - KB_EMBEDDING_PROVIDER=${KB_EMBEDDING_PROVIDER:-openai}
      - KB_EMBEDDING_BASE_URL=${KB_EMBEDDING_BASE_URL:-}
      - KB_EMBEDDING_MODEL=${KB_EMBEDDING_MODEL:-text-embedding-3-small}
      - KB_EMBEDDING_DIMENSIONS=${KB_EMBEDDING_DIMENSIONS:-1536}
      # Storage
      - STORAGE_BACKEND=${STORAGE_BACKEND:-s3}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-worqlo}
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-worqlo}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - S3_ENDPOINT_URL=http://minio:9000
      - S3_PUBLIC_ENDPOINT_URL=${S3_PUBLIC_ENDPOINT_URL:-http://localhost:9000}
      - S3_PRESIGNED_URL_EXPIRY=${S3_PRESIGNED_URL_EXPIRY:-3600}
      # Public API URL (for generating absolute file view links)
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost/api}
      # Celery
      - CELERY_TASK_DEFAULT_QUEUE=default
    volumes:
      - uploads-data:/app/uploads
    networks:
      - backend-network
      - db-network
      - external-network  # Required for OpenAI, webhooks
    depends_on:
      api:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    # Override Dockerfile health check (Celery doesn't expose HTTP)
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.workflows.celery_app inspect ping -d celery@$$HOSTNAME || exit 0"]
      interval: 60s
      timeout: 30s
      start_period: 30s
      retries: 3
    # Security hardening
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # ===========================================================================
  # Celery Beat - Task Scheduler
  # ===========================================================================
  celery-beat:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: worqlo-celery-beat
    restart: unless-stopped
    command: celery -A app.workflows.celery_app beat -S sqlalchemy_celery_beat.schedulers:DatabaseScheduler --loglevel=info
    environment:
      # Skip migrations/seeds (handled by API container)
      - SKIP_STARTUP_TASKS=true
      # Database & Redis
      - DATABASE_URL=postgresql://${POSTGRES_USER:-worqlo}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-worqlo}
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      # JWT
      - JWT_WS_SECRET=${JWT_WS_SECRET}
      # Celery
      - CELERY_TASK_DEFAULT_QUEUE=default
    networks:
      - backend-network
      - db-network
      - external-network  # Required for notifications
    depends_on:
      celery-worker:
        condition: service_started
    # Disable Dockerfile health check (Celery Beat doesn't expose HTTP, and slim image has no ps/pgrep)
    healthcheck:
      disable: true
    # Security hardening
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: worqlo-postgres
    restart: unless-stopped
    # Remove external port - only accessible internally
    # For debugging, use: docker exec -it worqlo-postgres psql -U worqlo
    # ports:
    #   - "5433:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-worqlo}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_DB=${POSTGRES_DB:-worqlo}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - db-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-worqlo} -d ${POSTGRES_DB:-worqlo}"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Security hardening
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID

  # ===========================================================================
  # Redis - Caching & Rate Limiting
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: worqlo-redis
    restart: unless-stopped
    # Remove external port - only accessible internally
    # ports:
    #   - "6379:6379"
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
    volumes:
      - redis-data:/data
    networks:
      - db-network
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Security hardening
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID

  # ===========================================================================
  # MinIO - S3-Compatible Object Storage
  # ===========================================================================
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z  # Pinned version (latest on Docker Hub)
    container_name: worqlo-minio
    restart: unless-stopped
    # Port 9000 exposed via nginx proxy (minio ports not published - nginx proxies)
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-worqlo}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:?MINIO_ROOT_PASSWORD is required}
    volumes:
      - minio-data:/data
    networks:
      - db-network
      - minio-network   # Shared with nginx for browser file access
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3
    # Security hardening
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID

  # ===========================================================================
  # MinIO Client - Create Default Bucket
  # ===========================================================================
  minio-init:
    image: minio/mc:latest
    container_name: worqlo-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 ${MINIO_ROOT_USER:-worqlo} ${MINIO_ROOT_PASSWORD};
      mc mb myminio/${S3_BUCKET_NAME:-worqlo} --ignore-existing;
      mc anonymous set download myminio/${S3_BUCKET_NAME:-worqlo}/public;
      exit 0;
      "
    networks:
      - db-network
    # mc needs writable config dir; root fs may be read-only with cap_drop
    tmpfs:
      - /root/.mc
    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # ===========================================================================
  # Ollama - Local LLM (Optional, use --profile ollama)
  # ===========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: worqlo-ollama
    restart: unless-stopped
    profiles:
      - ollama
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - backend-network
    # Security hardening
    deploy:
      resources:
        limits:
          memory: 8G  # Adjust based on model size
          cpus: '4.0'
        reservations:
          memory: 2G
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Uncomment for GPU support (NVIDIA)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

# =============================================================================
# Networks (Segmented for Security)
# =============================================================================
networks:
  # Frontend network: nginx <-> chat-ui (allows incoming connections)
  frontend-network:
    driver: bridge
    internal: false
  
  # Backend network: internal service communication
  backend-network:
    driver: bridge
    internal: true
  
  # Database network: api <-> postgres, redis, minio (isolated)
  db-network:
    driver: bridge
    internal: true
  
  # MinIO network: nginx <-> minio (for presigned URL proxy)
  minio-network:
    driver: bridge
    internal: false  # nginx needs external port access
  
  # External network: for services that need internet access (SMTP, OpenAI, etc.)
  external-network:
    driver: bridge
    internal: false

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres-data:
  redis-data:
  minio-data:
  ollama-data:
  uploads-data:

